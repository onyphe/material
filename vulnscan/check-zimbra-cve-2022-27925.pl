#!/usr/bin/env perl
#
# ONYPHE 2023 - Patrice <GomoR> Auffret
#
# This program is a non-intrusive check for Zimbra CVE-2022-27925.
# It uses a POST request to mboximport endpoint and checks for '401 no authtoken cookie' response
# to assert if the target is vulnerable or not.
#
# You may need to install the following dependencies (Debian-based systems):
#
# sudo apt install perl libwww-perl liblwp-protocol-https-perl
#
use strict;
use warnings;

use LWP::UserAgent;
use LWP::Protocol::https;

#
# Example usage:
#
# perl check-zimbra-cve-2022-27925.pl https://www.example.com:1443/
# perl check-zimbra-cve-2022-27925.pl https://www.example.com admin
# perl check-zimbra-cve-2022-27925.pl https://www.example.com user@example.com
#
my $url = shift or die("Usage: $0 https://www.example.com [ email_account ]\n");
my $account = shift;

# Verify arguments:
if ($url !~ m{^https?://}) {
   die("ERROR: give a complete URL like https://example.com as a target to check\n");
}

# Select default user account when not provided by user:
if (!defined($account)) {
   my ($domain) = $url =~ m{^https?://([^:/]+)};
   $account = 'admin@'.$domain;
}

# Build non-intrusive check URL:
$url =~ s{/*$}{/service/extension/backup/mboximport?account-name=$account&account-status=1&ow=cmd};

# Use this configuration for checking:
print "Using URL:     [$url]\n";
print "Using account: [$account]\n";

# Create user agent, allow http & https and disable TLS certificate verifications.
# Configure proxy with HTTP_PROXY environment variable if required:
my $ua = LWP::UserAgent->new(
   agent => 'Check-Zimbra-CVE-2022-27925/1.0',
   protocols_allowed => ['http', 'https'],
   timeout => 5,
   ssl_opts => { verify_hostname => 0, SSL_verify_mode => 0x00 },
);
$ua->env_proxy;

# Send POST request with empty payload for a non-instrusive check:
my $response = $ua->post($url, []);
if (!defined($response)) {
   die("ERROR: POST request failed: $!\n");
}

# Analyze received response:
my $code = $response->code;
my $content = $response->content;
if ($code != 500) {
   print $content =~ m{Error 401 no authtoken cookie.+?Problem accessing /service/extension/backup/mboximport}si
      ? "\n*** Target IS vulnerable"
      : "\nTarget is not vulnerable";
   print "\n\nReceived content:\n\n$content\n";
}
else {
   my @lines = split("\n", $content);
   my $error = $lines[0];
   die("ERROR: POST request failed: $error\n");
}

exit(0);
